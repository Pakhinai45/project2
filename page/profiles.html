<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profiles</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
        }

        p {
            font-size: 18px;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            background-color: #28a745;
            color: white;
            border-radius: 5px;
        }

        button:hover {
            background-color: #218838;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <a href="#"><button id="backpage"><ion-icon name="arrow-back-outline"></ion-icon></button></a>
    <div class="container">
        <h1>ข้อมูลผู้ใช้</h1>
        <div id="userInfo">
            <p><strong>UID:</strong> <span id="uid"></span></p>
            <p><strong>ชื่อ:</strong> <span id="fname"></span></p>
            <p><strong>นามสกุล:</strong> <span id="lname"></span></p>
            <p><strong>อีเมล:</strong> <span id="email"></span></p>
            <p><strong>Token Line:</strong> <span id="tokenline"></span></p>
            <button id="editButton">แก้ไข</button>
        </div>
        <div id="editForm" class="hidden">
            <input type="text" id="editFname" placeholder="ชื่อ" />
            <input type="text" id="editLname" placeholder="นามสกุล" />
            <input type="email" id="editEmail" placeholder="อีเมล" />
            <input type="text" id="editTokenline" placeholder="Token Line" />
            <button id="saveButton">บันทึก</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');
        console.log("profileID = " + uid);

        fetchUserStatusFromDatabase(uid)
        .then(userData  => {
            const { uid, fname, lname, email , tokenline } = userData;

            document.getElementById('uid').textContent = uid;
            document.getElementById('fname').textContent = fname;
            document.getElementById('lname').textContent = lname;
            document.getElementById('email').textContent = email;
            document.getElementById('tokenline').textContent = tokenline;

        })
        .catch(error => {
            console.error('Error fetching user status:', error);
        });

        // ฟังก์ชันสำหรับดึงค่า status จาก Firebase
        function fetchUserStatusFromDatabase(uid) {
            return fetch(`http://localhost:3000/api/users/${uid}`) // เรียก API เพื่อนำข้อมูลสถานะผู้ใช้
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    return {uid: data.uid , fname: data.fname, lname: data.lname ,email: data.email  , tokenline: data.tokenline };
                });
        }

        // ฟังก์ชันเพื่อแสดงฟอร์มแก้ไข
        document.getElementById('editButton').addEventListener('click', function() {
            document.getElementById('editForm').classList.remove('hidden');
            document.getElementById('editFname').value = document.getElementById('fname').textContent;
            document.getElementById('editLname').value = document.getElementById('lname').textContent;
            document.getElementById('editEmail').value = document.getElementById('email').textContent;
            document.getElementById('editTokenline').value = document.getElementById('tokenline').textContent;
            document.getElementById('userInfo').classList.add('hidden');
        });

        // ฟังก์ชันเพื่อบันทึกข้อมูลที่แก้ไข
        document.getElementById('saveButton').addEventListener('click', function() {
            const updatedData = {
                fname: document.getElementById('editFname').value,
                lname: document.getElementById('editLname').value,
                email: document.getElementById('editEmail').value,
                tokenline: document.getElementById('editTokenline').value
            };
            // ทำการส่งข้อมูลไปที่ API
            updateUserStatusInDatabase(uid, updatedData);
        });
///
        function updateUserStatusInDatabase(uid, updatedData) {
            fetch(`http://localhost:3000/api/editusers/${uid}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('User updated:', data);
                // อัปเดตข้อมูลในหน้าแสดงผล
                document.getElementById('fname').textContent = updatedData.fname;
                document.getElementById('lname').textContent = updatedData.lname;
                document.getElementById('email').textContent = updatedData.email;
                document.getElementById('tokenline').textContent = updatedData.tokenline;
                // ซ่อนฟอร์มแก้ไขและแสดงข้อมูลผู้ใช้
                document.getElementById('editForm').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error updating user:', error);
            });
        }


        document.getElementById('backpage').addEventListener('click', function(event) {
            event.preventDefault(); // หยุดการทำงานเริ่มต้นของลิงก์
            window.location.href = `home.html?uid=${uid}`; // เปลี่ยนเส้นทางไปยังหน้า
        });

    </script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.2/dist/ionicons/ionicons.js"></script>
</body>
</html>
